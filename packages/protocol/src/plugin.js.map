{"version":3,"file":"plugin.js","sourceRoot":"","sources":["plugin.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  EncodingOptions,\n  OutgoingP2PMessage,\n  ProtocolEvents,\n  ProtocolMessage,\n  PluginInterface,\n  ProtocolRequest,\n  Peer,\n  PluginEventDef,\n  ReceiveEventHandlers,\n  SubLoggerInterface,\n  IncomingP2PMessage,\n  CinderlinkClientInterface,\n  PluginEventHandlers,\n  CinderlinkClientEvents,\n} from \"@cinderlink/core-types\";\nimport { Connection, Stream } from \"@libp2p/interface\";\nimport * as json from \"multiformats/codecs/json\";\nimport * as lp from \"it-length-prefixed\";\nimport { pipe } from \"it-pipe\";\nimport { Pushable } from \"it-pushable\";\nimport map from \"it-map\";\n\n// Removed duplicate import - already imported above\nimport { decodePayload, encodePayload } from \"./encoding.js\";\n\nexport interface ProtocolHandler {\n  buffer: Pushable<Uint8Array>;\n  stream: Stream;\n  connection: Connection;\n  out: Promise<void>;\n  in: Promise<void>;\n}\n\nexport class CinderlinkProtocolPlugin<\n  PeerEvents extends PluginEventDef = PluginEventDef\n> implements PluginInterface<ProtocolEvents, PeerEvents, CinderlinkClientInterface<ProtocolEvents & PeerEvents>>\n{\n  id = \"cinderlink\";\n  logger: SubLoggerInterface;\n  keepAliveHandler: NodeJS.Timeout | undefined;\n  respondToKeepAlive = true;\n  started = false;\n\n  constructor(\n    public client: CinderlinkClientInterface<ProtocolEvents & PeerEvents>\n  ) {\n    this.logger = client.logger.module(\"protocol\");\n  }\n\n  p2p: ReceiveEventHandlers<ProtocolEvents> = {\n    \"/cinderlink/keepalive\": this.onKeepAlive.bind(this),\n  };\n\n  pubsub = {};\n  coreEvents: Partial<PluginEventHandlers<CinderlinkClientEvents[\"emit\"]>> = {\n    \"/peer/connect\": this.onPeerConnect.bind(this),\n    \"/peer/disconnect\": this.onPeerDisconnect.bind(this),\n  };\n  \n  pluginEvents?: PluginEventHandlers<PeerEvents[\"emit\"]>;\n\n  async start(): Promise<void> {\n    this.logger.info(`registering protocol /cinderlink/1.0.0`);\n    this.client.ipfs.libp2p.handle(\n      \"/cinderlink/1.0.0\",\n      this.handleProtocol.bind(this),\n      {\n        maxInboundStreams: 128,\n        maxOutboundStreams: 128,\n      }\n    );\n    this.keepAliveHandler = setInterval(\n      this.keepAliveCheck.bind(this),\n      this.client.keepAliveInterval\n    );\n  }\n\n  async stop(): Promise<void> {\n    clearInterval(this.keepAliveHandler);\n  }\n\n  handleProtocol({\n    stream,\n    connection,\n  }: {\n    stream: Stream;\n    connection: Connection;\n  }) {\n    const self = this;\n    pipe(\n      stream,\n      lp.decode,\n      (source: any) => {\n        return map(source, (buf: any) => {\n          return json.decode(buf) as ProtocolMessage<\n            ProtocolEvents[\"receive\"][keyof ProtocolEvents[\"receive\"]] &\n              ProtocolRequest,\n            keyof ProtocolEvents[\"receive\"]\n          >;\n        });\n      },\n      async function (source: any) {\n        try {\n          for await (const encoded of source) {\n            await self.handleProtocolMessage(connection, encoded);\n          }\n        } catch (_error) {\n          self.logger.error(`error handling protocol message`, {\n            message: (_error as Error).message,\n            trace: (_error as Error).stack,\n          });\n        }\n      }\n    ).catch((error: Error) => {\n      self.logger.error(`error handling protocol message`, {\n        message: error.message,\n        trace: error.stack,\n      });\n    });\n  }\n\n  async keepAliveCheck() {\n    const now = Date.now();\n    for (const peer of this.client.peers.getAllPeers()) {\n      if (peer.connected) {\n        if (\n          !peer.seenAt ||\n          now - peer.seenAt >= (this.client.keepAliveTimeout || 10000)\n        ) {\n          this.logger.info(`peer ${readablePeer(peer)} timed out`);\n          await this.client.emit(\"/cinderlink/keepalive/timeout\", peer);\n          try {\n            this.client.ipfs.libp2p.getConnections(peer.peerId).forEach((connection: Connection) => {\n              connection.close();\n            });\n            this.client.emit(\"/peer/disconnect\", peer);\n            this.client.peers.removePeer(peer.peerId.toString());\n          } catch (__) {}\n        } else {\n          await this.client.send(peer.peerId.toString(), {\n            topic: \"/cinderlink/keepalive\",\n            payload: {\n              timestamp: Date.now(),\n            },\n          } as OutgoingP2PMessage<ProtocolEvents, \"/cinderlink/keepalive\">);\n        }\n      }\n    }\n  }\n\n  onKeepAlive(\n    message: IncomingP2PMessage<\n      ProtocolEvents,\n      \"/cinderlink/keepalive\"\n    >\n  ) {\n    if (!this.respondToKeepAlive) return;\n    this.client.peers.updatePeer(message.peer.peerId.toString(), {\n      seenAt: Date.now(),\n    });\n  }\n\n  onPeerConnect(peer: Peer) {\n    if (this.client.peerId && peer.peerId.equals(this.client.peerId)) {\n      return;\n    }\n  }\n\n  onPeerDisconnect(peer: Peer) {\n    this.logger.info(`closing cinderlink protocol ${readablePeer(peer)}`);\n  }\n\n  async handleProtocolMessage(\n    connection: Connection,\n    encoded: ProtocolMessage<ProtocolRequest, string>\n  ) {\n    if (!encoded) {\n      this.logger.error(`invalid encoded message`, {\n        from: connection.remotePeer,\n        encoded,\n      });\n      throw new Error(\"invalid encoded message\");\n    }\n\n    const { topic } = encoded;\n    if (!topic) {\n      this.logger.error(`invalid topic in encoded message`, {\n        from: connection.remotePeer,\n        encoded,\n      });\n      throw new Error('missing \"topic\" in encoded message');\n    }\n\n    let peer = this.client.peers.getPeer(connection.remotePeer.toString());\n    if (!peer) {\n      this.logger.warn(`peer not found, creating peer`, {\n        from: connection.remotePeer,\n        encoded,\n      });\n      peer = await this.client.peers.addPeer(connection.remotePeer, \"peer\");\n    }\n\n    if (!encoded.signed && !encoded.encrypted) {\n      this.logger.error(\n        `invalid encoded message; must be signed or encrypted`,\n        {\n          from: connection.remotePeer,\n          encoded,\n        }\n      );\n      throw new Error(\"invalid encoded message; must be signed or encrypted\");\n    }\n\n    const decoded = await decodePayload(encoded, this.client.did);\n    if (!decoded) {\n      this.logger.error(\"failed to decode message (no data)\", {\n        encoded,\n        decoded,\n      });\n      throw new Error(\"failed to decode message (no data)\");\n      return;\n    }\n\n    if (!peer.did && decoded.sender) {\n      peer.did = decoded.sender;\n      this.client.emit(\"/peer/authenticated\", peer);\n    }\n\n    const event = {\n      topic,\n      peer,\n      ...decoded,\n    };\n\n    this.logger.info(\n      `received protocol message on topic ${event.topic as string} from ${\n        peer.did\n      }`,\n      event\n    );\n    if (event.payload && typeof event.payload === 'object' && 'requestId' in event.payload && event.payload.requestId) {\n      this.logger.info(\n        `received request message from ${peer.did}: ${event.payload.requestId}`\n      );\n      this.client.emit(\n        `/cinderlink/request/${event.payload.requestId}`,\n        event\n      );\n    }\n\n    await (this.client.p2p.emit as any)(topic, event);\n  }\n\n  async encodeMessage<\n    Topic extends keyof (\n      | ProtocolEvents<ProtocolEvents>[\"send\"]\n      | ProtocolEvents<ProtocolEvents>[\"publish\"]\n    ) = keyof (\n      | ProtocolEvents<ProtocolEvents>[\"send\"]\n      | ProtocolEvents<ProtocolEvents>[\"publish\"]\n    )\n  >(\n    message: OutgoingP2PMessage<ProtocolEvents, Topic>,\n    { sign, encrypt, recipients }: EncodingOptions = {} as EncodingOptions\n  ) {\n    return encodePayload(message, {\n      sign,\n      encrypt,\n      recipients,\n      did: this.client.did,\n    });\n  }\n}\n\nexport function readablePeer(peer: Peer) {\n  return `[peerId:${peer.peerId.toString()}, did:${\n    peer.did ? peer.did : \"N/A\"\n  }]`;\n}\n\nexport default CinderlinkProtocolPlugin;\n"]}