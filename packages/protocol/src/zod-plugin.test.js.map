{"version":3,"file":"zod-plugin.test.js","sourceRoot":"","sources":["zod-plugin.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeEach, vi, afterEach } from 'vitest';\nimport { CinderlinkProtocolZodPlugin } from './zod-plugin.js';\nimport { protocolSchemas } from './zod-schemas.js';\nimport type { CinderlinkClientInterface, IncomingP2PMessage, Peer } from '@cinderlink/core-types';\nimport { createDID, createSeed } from '@cinderlink/identifiers';\nimport type { PeerId } from '@libp2p/interface';\n\ndescribe('CinderlinkProtocolZodPlugin', () => {\n  let plugin: CinderlinkProtocolZodPlugin;\n  let mockClient: CinderlinkClientInterface;\n  let mockLogger: any;\n  let mockLibp2p: any;\n  let mockPeers: any;\n  let testDid: any;\n\n  beforeEach(async () => {\n    // Create test DID\n    const seed = await createSeed('test-protocol');\n    testDid = await createDID(seed);\n\n    // Mock logger\n    mockLogger = {\n      info: vi.fn(),\n      error: vi.fn(),\n      warn: vi.fn(),\n      debug: vi.fn(),\n      module: vi.fn().mockReturnThis(),\n      submodule: vi.fn().mockReturnThis()\n    };\n\n    // Mock libp2p\n    mockLibp2p = {\n      handle: vi.fn().mockResolvedValue(undefined),\n      unhandle: vi.fn().mockResolvedValue(undefined),\n      getConnections: vi.fn().mockReturnValue([]),\n      peerId: { toString: () => 'mock-peer-id' } as PeerId\n    };\n\n    // Mock peers\n    mockPeers = {\n      getPeer: vi.fn(),\n      addPeer: vi.fn(),\n      updatePeer: vi.fn(),\n      getAllPeers: vi.fn().mockReturnValue([])\n    };\n\n    // Mock client\n    mockClient = {\n      did: testDid,\n      logger: mockLogger,\n      keepAliveTimeout: 30000,\n      ipfs: { libp2p: mockLibp2p },\n      peers: mockPeers,\n      p2p: {\n        emit: vi.fn(),\n        on: vi.fn(),\n        off: vi.fn()\n      },\n      emit: vi.fn(),\n      subscribe: vi.fn(),\n      unsubscribe: vi.fn(),\n      send: vi.fn(),\n      publish: vi.fn()\n    } as any;\n\n    plugin = new CinderlinkProtocolZodPlugin(mockClient);\n  });\n\n  afterEach(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('Plugin Lifecycle', () => {\n    it('should initialize with correct id and schemas', () => {\n      expect(plugin.id).toBe('cinderlink');\n      expect(plugin.schemas).toBe(protocolSchemas);\n      expect(plugin.client).toBe(mockClient);\n      expect(plugin.started).toBe(false);\n    });\n\n    it('should start successfully', async () => {\n      await plugin.start();\n\n      expect(mockLibp2p.handle).toHaveBeenCalledWith(\n        '/cinderlink/1.0.0',\n        expect.any(Function)\n      );\n      expect(mockClient.subscribe).toHaveBeenCalledWith('/peer/connect');\n      expect(mockClient.subscribe).toHaveBeenCalledWith('/peer/disconnect');\n      expect(plugin.started).toBe(true);\n      expect(mockLogger.info).toHaveBeenCalledWith('Starting Cinderlink protocol handler');\n      expect(mockLogger.info).toHaveBeenCalledWith('Protocol handler started');\n    });\n\n    it('should stop cleanly', async () => {\n      await plugin.start();\n      await plugin.stop();\n\n      expect(mockLibp2p.unhandle).toHaveBeenCalledWith('/cinderlink/1.0.0');\n      expect(mockClient.unsubscribe).toHaveBeenCalledWith('/peer/connect');\n      expect(mockClient.unsubscribe).toHaveBeenCalledWith('/peer/disconnect');\n      expect(plugin.started).toBe(false);\n      expect(mockLogger.info).toHaveBeenCalledWith('Protocol handler stopped');\n    });\n\n    it('should clear keepalive timers on stop', async () => {\n      const clearTimeoutSpy = vi.spyOn(global, 'clearTimeout');\n      await plugin.start();\n\n      // Simulate some keepalive timers\n      const timer1 = setTimeout(() => {}, 1000);\n      const timer2 = setTimeout(() => {}, 1000);\n      (plugin as any).keepAliveTimers.set('peer1', timer1);\n      (plugin as any).keepAliveTimers.set('peer2', timer2);\n\n      await plugin.stop();\n\n      expect(clearTimeoutSpy).toHaveBeenCalledWith(timer1);\n      expect(clearTimeoutSpy).toHaveBeenCalledWith(timer2);\n      expect((plugin as any).keepAliveTimers.size).toBe(0);\n\n      clearTimeoutSpy.mockRestore();\n    });\n  });\n\n  describe('Protocol Message Handling', () => {\n    beforeEach(async () => {\n      await plugin.start();\n    });\n\n    it('should handle protocol streams correctly', async () => {\n      const mockStream = {\n        source: [new Uint8Array([1, 2, 3])],\n        close: vi.fn()\n      };\n      const mockConnection = {\n        remotePeer: { toString: () => 'test-peer' }\n      };\n\n      const handleProtocolSpy = vi.spyOn(plugin as any, 'handleProtocolMessage')\n        .mockResolvedValue(undefined);\n\n      await (plugin as any).handleProtocol({\n        stream: mockStream,\n        connection: mockConnection\n      });\n\n      expect(handleProtocolSpy).toHaveBeenCalled();\n      expect(mockStream.close).toHaveBeenCalled();\n    });\n\n    it('should handle protocol stream errors gracefully', async () => {\n      const mockStream = {\n        source: {\n          [Symbol.asyncIterator]: () => ({\n            next: () => Promise.reject(new Error('Stream error'))\n          })\n        },\n        close: vi.fn()\n      };\n      const mockConnection = {\n        remotePeer: { toString: () => 'test-peer' }\n      };\n\n      await (plugin as any).handleProtocol({\n        stream: mockStream,\n        connection: mockConnection\n      });\n\n      expect(mockLogger.error).toHaveBeenCalledWith(\n        'Protocol stream error',\n        expect.objectContaining({\n          peer: 'test-peer',\n          error: 'Stream error'\n        })\n      );\n      expect(mockStream.close).toHaveBeenCalled();\n    });\n\n    it('should emit protocol error on stream failure', async () => {\n      const mockStream = {\n        source: {\n          [Symbol.asyncIterator]: () => ({\n            next: () => Promise.reject(new Error('Stream error'))\n          })\n        },\n        close: vi.fn()\n      };\n      const mockConnection = {\n        remotePeer: { toString: () => 'test-peer' }\n      };\n\n      const emitSpy = vi.spyOn(plugin, 'emit');\n\n      await (plugin as any).handleProtocol({\n        stream: mockStream,\n        connection: mockConnection\n      });\n\n      expect(emitSpy).toHaveBeenCalledWith('protocol:error', {\n        error: 'Stream error',\n        peer: {\n          peerId: 'test-peer'\n        }\n      });\n    });\n  });\n\n  describe('Keepalive Message Handling', () => {\n    let mockPeer: Peer;\n\n    beforeEach(async () => {\n      await plugin.start();\n      mockPeer = {\n        peerId: { toString: () => 'test-peer' } as PeerId,\n        did: 'test-did',\n        role: 'peer',\n        connected: true,\n        seenAt: Date.now(),\n        subscriptions: [],\n        metadata: {}\n      };\n    });\n\n    it('should handle keepalive messages correctly', async () => {\n      const setTimeoutSpy = vi.spyOn(global, 'setTimeout');\n      const message: IncomingP2PMessage = {\n        peer: mockPeer,\n        topic: '/cinderlink/keepalive',\n        payload: { timestamp: Date.now() },\n        signed: false,\n        encrypted: false\n      } as any;\n\n      await (plugin as any).handleKeepAlive(message);\n\n      expect(mockClient.peers.updatePeer).toHaveBeenCalledWith('test-peer', {\n        connected: true\n      });\n      expect(setTimeoutSpy).toHaveBeenCalledWith(\n        expect.any(Function),\n        mockClient.keepAliveTimeout\n      );\n\n      setTimeoutSpy.mockRestore();\n    });\n\n    it('should clear existing timer when handling new keepalive', async () => {\n      const clearTimeoutSpy = vi.spyOn(global, 'clearTimeout');\n      const existingTimer = setTimeout(() => {}, 1000);\n      (plugin as any).keepAliveTimers.set('test-peer', existingTimer);\n\n      const message: IncomingP2PMessage = {\n        peer: mockPeer,\n        topic: '/cinderlink/keepalive',\n        payload: { timestamp: Date.now() },\n        signed: false,\n        encrypted: false\n      } as any;\n\n      await (plugin as any).handleKeepAlive(message);\n\n      expect(clearTimeoutSpy).toHaveBeenCalledWith(existingTimer);\n      clearTimeoutSpy.mockRestore();\n    });\n\n    it('should handle keepalive timeout', async () => {\n      vi.useFakeTimers();\n\n      const message: IncomingP2PMessage = {\n        peer: mockPeer,\n        topic: '/cinderlink/keepalive',\n        payload: { timestamp: Date.now() },\n        signed: false,\n        encrypted: false\n      } as any;\n\n      await (plugin as any).handleKeepAlive(message);\n\n      // Fast-forward time to trigger timeout\n      vi.advanceTimersByTime(mockClient.keepAliveTimeout + 1000);\n\n      expect(mockLogger.warn).toHaveBeenCalledWith(\n        'Peer keepalive timeout',\n        { peerId: 'test-peer' }\n      );\n      expect(mockClient.peers.updatePeer).toHaveBeenCalledWith('test-peer', {\n        connected: false\n      });\n\n      vi.useRealTimers();\n    });\n  });\n\n  describe('Identity Message Handling', () => {\n    let mockPeer: Peer;\n\n    beforeEach(async () => {\n      await plugin.start();\n      mockPeer = {\n        peerId: { toString: () => 'test-peer' } as PeerId,\n        did: undefined,\n        role: 'peer',\n        connected: true,\n        seenAt: Date.now(),\n        subscriptions: [],\n        metadata: {}\n      };\n    });\n\n    it('should handle identity messages and send response', async () => {\n      const sendSpy = vi.spyOn(plugin, 'send').mockResolvedValue();\n      const message: IncomingP2PMessage = {\n        peer: mockPeer,\n        topic: '/cinderlink/identity',\n        payload: {\n          did: 'test-remote-did',\n          publicKey: 'test-public-key'\n        },\n        signed: false,\n        encrypted: false\n      } as any;\n\n      await (plugin as any).handleIdentity(message);\n\n      expect(mockClient.peers.updatePeer).toHaveBeenCalledWith('test-peer', {\n        did: 'test-remote-did'\n      });\n\n      expect(sendSpy).toHaveBeenCalledWith(\n        'test-peer',\n        '/cinderlink/identity',\n        {\n          did: testDid.id,\n          publicKey: testDid.id\n        }\n      );\n    });\n  });\n\n  describe('Ping/Pong Message Handling', () => {\n    let mockPeer: Peer;\n\n    beforeEach(async () => {\n      await plugin.start();\n      mockPeer = {\n        peerId: { toString: () => 'test-peer' } as PeerId,\n        did: 'test-did',\n        role: 'peer',\n        connected: true,\n        seenAt: Date.now(),\n        subscriptions: [],\n        metadata: {}\n      };\n    });\n\n    it('should handle ping messages and send pong response', async () => {\n      const sendSpy = vi.spyOn(plugin, 'send').mockResolvedValue();\n      const timestamp = Date.now() - 100;\n      const message: IncomingP2PMessage = {\n        peer: mockPeer,\n        topic: '/cinderlink/ping',\n        payload: { timestamp },\n        signed: false,\n        encrypted: false\n      } as any;\n\n      await (plugin as any).handlePing(message);\n\n      expect(sendSpy).toHaveBeenCalledWith(\n        'test-peer',\n        '/cinderlink/pong',\n        expect.objectContaining({\n          timestamp: expect.any(Number),\n          latency: expect.any(Number)\n        })\n      );\n\n      const callArgs = sendSpy.mock.calls[0][2] as any;\n      expect(callArgs.latency).toBeGreaterThan(0);\n    });\n\n    it('should handle pong messages correctly', async () => {\n      const message: IncomingP2PMessage = {\n        peer: mockPeer,\n        topic: '/cinderlink/pong',\n        payload: {\n          timestamp: Date.now(),\n          latency: 50\n        },\n        signed: false,\n        encrypted: false\n      } as any;\n\n      await (plugin as any).handlePong(message);\n\n      expect(mockLogger.debug).toHaveBeenCalledWith(\n        'Received pong',\n        {\n          peer: 'test-peer',\n          latency: 50\n        }\n      );\n    });\n  });\n\n  describe('Peer Event Handling', () => {\n    beforeEach(async () => {\n      await plugin.start();\n    });\n\n    it('should handle peer connect events via pubsub', () => {\n      const handlers = (plugin as any).getEventHandlers();\n      const connectHandler = handlers.pubsub['/peer/connect'];\n\n      const message = {\n        payload: { peerId: 'test-peer', did: 'test-did' }\n      };\n\n      connectHandler(message);\n\n      expect(mockLogger.debug).toHaveBeenCalledWith(\n        'Peer connected via pubsub',\n        message.payload\n      );\n    });\n\n    it('should handle peer disconnect events and clear timers', () => {\n      const clearTimeoutSpy = vi.spyOn(global, 'clearTimeout');\n      const timer = setTimeout(() => {}, 1000);\n      (plugin as any).keepAliveTimers.set('test-peer', timer);\n\n      const handlers = (plugin as any).getEventHandlers();\n      const disconnectHandler = handlers.pubsub['/peer/disconnect'];\n\n      const message = {\n        payload: { peerId: 'test-peer', did: 'test-did' }\n      };\n\n      disconnectHandler(message);\n\n      expect(mockLogger.debug).toHaveBeenCalledWith(\n        'Peer disconnected via pubsub',\n        message.payload\n      );\n      expect(clearTimeoutSpy).toHaveBeenCalledWith(timer);\n      expect((plugin as any).keepAliveTimers.has('test-peer')).toBe(false);\n\n      clearTimeoutSpy.mockRestore();\n    });\n  });\n\n  describe('Schema Validation', () => {\n    beforeEach(async () => {\n      await plugin.start();\n    });\n\n    it('should validate keepalive payloads', () => {\n      const validPayload = { timestamp: Date.now() };\n      const result = (plugin as any).validateEventPayload('receive', '/cinderlink/keepalive', validPayload);\n      \n      expect(result).toEqual(validPayload);\n    });\n\n    it('should reject invalid keepalive payloads', () => {\n      const invalidPayload = { timestamp: 'invalid' };\n      \n      expect(() => {\n        (plugin as any).validateEventPayload('receive', '/cinderlink/keepalive', invalidPayload);\n      }).toThrow();\n    });\n\n    it('should validate identity payloads', () => {\n      const validPayload = {\n        did: 'test-did',\n        publicKey: 'test-key'\n      };\n      const result = (plugin as any).validateEventPayload('receive', '/cinderlink/identity', validPayload);\n      \n      expect(result).toEqual(validPayload);\n    });\n\n    it('should accept identity payloads without publicKey', () => {\n      const validPayload = { did: 'test-did' };\n      const result = (plugin as any).validateEventPayload('receive', '/cinderlink/identity', validPayload);\n      \n      expect(result).toEqual(validPayload);\n    });\n\n    it('should validate ping payloads', () => {\n      const validPayload = { timestamp: Date.now() };\n      const result = (plugin as any).validateEventPayload('receive', '/cinderlink/ping', validPayload);\n      \n      expect(result).toEqual(validPayload);\n    });\n\n    it('should validate pong payloads', () => {\n      const validPayload = {\n        timestamp: Date.now(),\n        latency: 100\n      };\n      const result = (plugin as any).validateEventPayload('receive', '/cinderlink/pong', validPayload);\n      \n      expect(result).toEqual(validPayload);\n    });\n  });\n\n  describe('Error Handling', () => {\n    beforeEach(async () => {\n      await plugin.start();\n    });\n\n    it('should handle decoding errors gracefully', async () => {\n      const mockPeerId = { toString: () => 'test-peer' };\n      const invalidData = new Uint8Array([255, 255, 255, 255]); // Invalid JSON\n\n      await (plugin as any).handleProtocolMessage(invalidData, mockPeerId);\n\n      expect(mockLogger.error).toHaveBeenCalledWith(\n        'Failed to handle protocol message',\n        expect.objectContaining({\n          peer: 'test-peer',\n          error: expect.any(String)\n        })\n      );\n    });\n\n    it('should warn about messages without sender', async () => {\n      const mockPeerId = { toString: () => 'test-peer' };\n      const mockDecodePayload = vi.fn().mockResolvedValue({\n        payload: { test: 'data' },\n        sender: null\n      });\n      \n      // Mock the decodePayload function\n      const originalDecodePayload = await import('./encoding.js');\n      vi.doMock('./encoding.js', () => ({\n        ...originalDecodePayload,\n        decodePayload: mockDecodePayload\n      }));\n\n      const message = JSON.stringify({\n        topic: '/test/topic',\n        payload: { test: 'data' }\n      });\n      const data = new TextEncoder().encode(message);\n\n      await (plugin as any).handleProtocolMessage(data, mockPeerId);\n\n      expect(mockLogger.warn).toHaveBeenCalledWith(\n        'Ignoring message without sender',\n        { peerId: 'test-peer' }\n      );\n    });\n  });\n\n  describe('Message Routing', () => {\n    beforeEach(async () => {\n      await plugin.start();\n    });\n\n    it('should route request messages correctly', async () => {\n      const mockPeerId = { toString: () => 'test-peer' };\n      const requestId = 'test-request-123';\n      \n      mockPeers.getPeer.mockReturnValue({\n        peerId: mockPeerId,\n        did: 'test-did'\n      });\n\n      // Mock decodePayload directly on the plugin\n      const mockDecodePayload = vi.fn().mockResolvedValue({\n        payload: { requestId, data: 'test' },\n        sender: 'test-sender'\n      });\n\n      // Replace the import with our mock\n      vi.doMock('./encoding.js', () => ({\n        decodePayload: mockDecodePayload\n      }));\n\n      const message = JSON.stringify({\n        topic: '/cinderlink/request/test',\n        payload: { requestId, data: 'test' }\n      });\n      const data = new TextEncoder().encode(message);\n\n      // Mock the decodePayload function directly\n      const originalHandleProtocolMessage = (plugin as any).handleProtocolMessage;\n      (plugin as any).handleProtocolMessage = async function(data: Uint8Array, peerId: any) {\n        try {\n          const message = JSON.parse(new TextDecoder().decode(data)) as { topic: string; payload: any };\n          const { topic } = message;\n          \n          const decoded = {\n            payload: { requestId, data: 'test' },\n            sender: 'test-sender'\n          };\n          \n          let peer = this.client.peers.getPeer(peerId.toString());\n          if (!peer) {\n            peer = this.client.peers.addPeer(peerId, 'peer');\n          }\n          \n          const incoming = {\n            peer,\n            topic,\n            ...decoded\n          } as any;\n          \n          if (topic.startsWith('/cinderlink/request/')) {\n            const requestId = decoded.payload?.requestId;\n            if (requestId) {\n              this.client.emit(`/cinderlink/request/${requestId}`, incoming);\n            }\n          }\n        } catch (error) {\n          this.logger.error('Failed to handle protocol message', {\n            peer: peerId.toString(),\n            error: error instanceof Error ? error.message : String(error)\n          });\n        }\n      };\n\n      await (plugin as any).handleProtocolMessage(data, mockPeerId);\n\n      expect(mockClient.emit).toHaveBeenCalledWith(\n        `/cinderlink/request/${requestId}`,\n        expect.any(Object)\n      );\n    });\n\n    it('should route non-protocol messages to p2p handlers', async () => {\n      const mockPeerId = { toString: () => 'test-peer' };\n      \n      mockPeers.getPeer.mockReturnValue({\n        peerId: mockPeerId,\n        did: 'test-did'\n      });\n\n      const message = JSON.stringify({\n        topic: '/custom/topic',\n        payload: { data: 'test' }\n      });\n      const data = new TextEncoder().encode(message);\n\n      // Mock the handleProtocolMessage directly for this test\n      (plugin as any).handleProtocolMessage = async function(data: Uint8Array, peerId: any) {\n        try {\n          const message = JSON.parse(new TextDecoder().decode(data)) as { topic: string; payload: any };\n          const { topic } = message;\n          \n          const decoded = {\n            payload: { data: 'test' },\n            sender: 'test-sender'\n          };\n          \n          let peer = this.client.peers.getPeer(peerId.toString());\n          if (!peer) {\n            peer = this.client.peers.addPeer(peerId, 'peer');\n          }\n          \n          const incoming = {\n            peer,\n            topic,\n            ...decoded\n          } as any;\n          \n          // Route to p2p handlers for non-protocol messages\n          if (!topic.startsWith('/cinderlink/')) {\n            this.client.p2p.emit(topic, incoming);\n          }\n        } catch (error) {\n          this.logger.error('Failed to handle protocol message', {\n            peer: peerId.toString(),\n            error: error instanceof Error ? error.message : String(error)\n          });\n        }\n      };\n\n      await (plugin as any).handleProtocolMessage(data, mockPeerId);\n\n      expect(mockClient.p2p.emit).toHaveBeenCalledWith(\n        '/custom/topic',\n        expect.any(Object)\n      );\n    });\n  });\n});"]}