{"version":3,"file":"encoding.test.js","sourceRoot":"","sources":["encoding.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, beforeAll } from \"vitest\";\nimport { decodePayload, encodePayload } from \"./encoding.js\";\nimport { createDID, createSeed } from \"@cinderlink/identifiers\";\nimport type { ProtocolRequest } from \"@cinderlink/core-types\";\n\ndescribe(\"Protocol Encoding\", () => {\n  let did: any;\n\n  beforeAll(async () => {\n    const seed = await createSeed(\"test-encoding\");\n    did = await createDID(seed);\n  });\n\n  it(\"should encode and decode unsigned payload\", async () => {\n    const originalPayload: ProtocolRequest = {\n      topic: \"/test/message\",\n      payload: { message: \"hello world\" }\n    };\n\n    const encoded = await encodePayload(originalPayload, { sign: false, encrypt: false }, did);\n    const decoded = await decodePayload(encoded, did);\n\n    expect(decoded.payload).toEqual(originalPayload);\n    expect(decoded.senderDid).toBeUndefined();\n    expect(encoded.signed).toBe(false);\n    expect(encoded.encrypted).toBe(false);\n  });\n\n  it(\"should encode and decode signed payload\", async () => {\n    const originalPayload: ProtocolRequest = {\n      topic: \"/test/signed\",\n      payload: { data: \"signed message\" }\n    };\n\n    const encoded = await encodePayload(originalPayload, { sign: true, encrypt: false, did });\n    const decoded = await decodePayload(encoded, did);\n\n    expect(decoded.payload).toEqual(originalPayload);\n    // Note: senderDid verification depends on DID resolution which may not work in test environment\n    expect(encoded.signed).toBe(true);\n    expect(encoded.encrypted).toBe(false);\n  });\n\n  it(\"should encode and decode encrypted payload\", async () => {\n    const originalPayload: ProtocolRequest = {\n      topic: \"/test/encrypted\",\n      payload: { secret: \"encrypted data\" }\n    };\n\n    const encoded = await encodePayload(originalPayload, { \n      sign: false, \n      encrypt: true, \n      did,\n      recipients: [did.id] \n    });\n    const decoded = await decodePayload(encoded, did);\n\n    expect(decoded.payload).toEqual(originalPayload);\n    expect(encoded.signed).toBe(false);\n    expect(encoded.encrypted).toBe(true);\n    // Encrypted payload should be a JWE object\n    expect(typeof encoded.payload).toBe(\"object\");\n  });\n\n  it(\"should reject signing and encrypting in same operation\", async () => {\n    const originalPayload: ProtocolRequest = {\n      topic: \"/test/signed-encrypted\",\n      payload: { confidential: \"secret signed data\" }\n    };\n\n    await expect(encodePayload(originalPayload, { \n      sign: true, \n      encrypt: true, \n      did,\n      recipients: [did.id] \n    })).rejects.toThrow(\"Cannot both sign and encrypt in a single operation\");\n  });\n\n  it(\"should throw error when decoding signed payload without DID\", async () => {\n    const payload: ProtocolRequest = {\n      topic: \"/test/no-did\",\n      payload: { message: \"test\" }\n    };\n\n    const encoded = await encodePayload(payload, { sign: true, encrypt: false, did });\n    \n    await expect(decodePayload(encoded)).rejects.toThrow(\"DID required to verify JWS\");\n  });\n\n  it(\"should throw error when decoding encrypted payload without DID\", async () => {\n    const payload: ProtocolRequest = {\n      topic: \"/test/no-did-encrypt\",\n      payload: { message: \"test\" }\n    };\n\n    const encoded = await encodePayload(payload, { \n      sign: false, \n      encrypt: true, \n      did,\n      recipients: [did.id] \n    });\n    \n    await expect(decodePayload(encoded)).rejects.toThrow(\"DID required to decrypt JWE\");\n  });\n});"]}